<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Alitas "El Dog" - Men√∫</title>

<style>
:root{
  --bg:#0b0f14;
  --panel:#0f1520;
  --card:#121a27;
  --card2:#0f1520;
  --border:#223045;
  --muted:#9fb0c3;
  --text:#eaf2ff;
  --accent:#f6c177;
  --accent2:#ff9f66;
  --danger:#ff5d5d;
  --ok:#67e8a5;
  --shadow: 0 10px 30px rgba(0,0,0,.35);
  --r:16px;
}

*{ box-sizing:border-box; }
body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, Helvetica, sans-serif;
  background:
    radial-gradient(1200px 600px at 10% -10%, rgba(246,193,119,.22), transparent 55%),
    radial-gradient(900px 500px at 90% 0%, rgba(255,159,102,.12), transparent 60%),
    var(--bg);
  color:var(--text);
}

/* ===== HEADER ===== */
header{
  position:sticky;
  top:0;
  z-index:50;
  background: linear-gradient(180deg, rgba(15,21,32,.92), rgba(15,21,32,.75));
  backdrop-filter: blur(10px);
  border-bottom:1px solid rgba(34,48,69,.6);
}

.header-inner{
  max-width:1100px;
  margin:auto;
  padding:14px 18px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:14px;
}

.brand{
  display:flex;
  align-items:center;
  gap:10px;
  min-width:190px;
}
.brand .logo{
  width:40px;height:40px;
  border-radius:12px;
  display:grid;
  place-items:center;
  background: rgba(246,193,119,.12);
  border:1px solid rgba(246,193,119,.35);
  box-shadow: var(--shadow);
}
.brand h1{
  font-size:18px;
  margin:0;
  line-height:1.1;
}
.brand .sub{
  display:block;
  font-size:12px;
  color:var(--muted);
  margin-top:2px;
}

.top-actions{
  display:flex;
  align-items:center;
  gap:10px;
  flex:1;
  justify-content:flex-end;
}

.search{
  flex:1;
  max-width:520px;
  display:flex;
  align-items:center;
  gap:10px;
  background: rgba(18,26,39,.7);
  border:1px solid rgba(34,48,69,.7);
  border-radius:999px;
  padding:10px 12px;
}
.search input{
  width:100%;
  background:transparent;
  border:none;
  outline:none;
  color:var(--text);
  font-size:14px;
}
.search .hint{
  font-size:12px;
  color:var(--muted);
  white-space:nowrap;
}

.btn{
  background: linear-gradient(180deg, rgba(246,193,119,1), rgba(255,159,102,1));
  border:none;
  padding:10px 14px;
  border-radius:999px;
  cursor:pointer;
  font-weight:800;
  color:#1a1208;
  box-shadow: 0 10px 22px rgba(246,193,119,.18);
}
.btn:active{ transform: translateY(1px); }

.btn-ghost{
  background: rgba(18,26,39,.65);
  border:1px solid rgba(34,48,69,.8);
  padding:10px 14px;
  border-radius:999px;
  cursor:pointer;
  font-weight:700;
  color:var(--text);
}

.badge{
  display:inline-grid;
  place-items:center;
  min-width:22px;
  height:22px;
  padding:0 8px;
  border-radius:999px;
  background: rgba(246,193,119,.14);
  border:1px solid rgba(246,193,119,.35);
  color:var(--accent);
  font-size:12px;
  font-weight:800;
}

/* ===== BODY ===== */
.container{
  max-width:1100px;
  margin:auto;
  padding:18px;
}

.hero{
  margin-top:18px;
  background: linear-gradient(180deg, rgba(18,26,39,.85), rgba(15,21,32,.55));
  border:1px solid rgba(34,48,69,.7);
  border-radius: var(--r);
  padding:16px;
  box-shadow: var(--shadow);
  display:flex;
  gap:16px;
  align-items:center;
  justify-content:space-between;
  flex-wrap:wrap;
}
.hero .left{
  display:flex;
  flex-direction:column;
  gap:6px;
}
.hero .title{
  margin:0;
  font-size:20px;
}
.hero .meta{
  color:var(--muted);
  font-size:13px;
}
.chips{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
.chip{
  padding:8px 10px;
  border-radius:999px;
  background: rgba(18,26,39,.65);
  border:1px solid rgba(34,48,69,.75);
  color:var(--text);
  cursor:pointer;
  font-size:12px;
  font-weight:700;
}
.chip.active{
  border-color: rgba(246,193,119,.6);
  background: rgba(246,193,119,.14);
  color: var(--accent);
}

.section{
  margin-top:24px;
}
.section h2{
  margin:0 0 12px;
  color: var(--accent);
  font-size:16px;
  letter-spacing:.2px;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
  gap:14px;
}

.card{
  background: linear-gradient(180deg, rgba(18,26,39,.92), rgba(15,21,32,.6));
  border:1px solid rgba(34,48,69,.75);
  border-radius: var(--r);
  overflow:hidden;
  box-shadow: var(--shadow);
  display:flex;
  flex-direction:column;
  min-height: 320px;
}
.thumb{
  width:100%;
  height:160px;
  background: rgba(11,15,20,.55);
  border-bottom:1px solid rgba(34,48,69,.6);
  display:grid;
  place-items:center;
}
.thumb img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
}
.thumb .noimg{
  color: rgba(159,176,195,.65);
  font-size:12px;
}

.card-body{
  padding:14px;
  display:flex;
  flex-direction:column;
  gap:10px;
  flex:1;
}
.card h3{
  margin:0;
  font-size:16px;
}
.desc{
  color: var(--muted);
  font-size:13px;
  line-height:1.35;
  min-height: 34px;
}
.row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.price{
  font-weight:900;
  color: var(--accent);
  font-size:15px;
}
.select{
  width:100%;
  padding:10px;
  border-radius:12px;
  border:1px solid rgba(34,48,69,.85);
  background: rgba(11,15,20,.55);
  color: var(--text);
  outline:none;
}
.small{
  color: var(--muted);
  font-size:12px;
}
.add{
  margin-top:auto;
  width:100%;
  border:none;
  padding:11px 12px;
  border-radius:12px;
  cursor:pointer;
  font-weight:900;
  color:#1a1208;
  background: linear-gradient(180deg, rgba(246,193,119,1), rgba(255,159,102,1));
}
.add:active{ transform: translateY(1px); }

/* ===== FAB carrito ===== */
.fab{
  position:fixed;
  right:16px;
  bottom:16px;
  z-index:60;
  display:flex;
  align-items:center;
  gap:10px;
  padding:12px 14px;
  border-radius:999px;
  background: rgba(18,26,39,.75);
  border:1px solid rgba(34,48,69,.8);
  box-shadow: var(--shadow);
  cursor:pointer;
  user-select:none;
}
.fab .dot{
  width:10px;height:10px;border-radius:50%;
  background: var(--accent);
  box-shadow:0 0 0 6px rgba(246,193,119,.12);
}
.fab span{ font-weight:800; }
.fab .badge{ margin-left:4px; }

/* ===== DRAWER carrito ===== */
.overlay{
  position:fixed;
  inset:0;
  background: rgba(0,0,0,.45);
  opacity:0;
  pointer-events:none;
  transition:.2s;
  z-index:70;
}
.overlay.open{ opacity:1; pointer-events:auto; }

.cart{
  position:fixed;
  right:0;
  top:0;
  height:100%;
  width:min(400px, 92vw);
  background: linear-gradient(180deg, rgba(15,21,32,.98), rgba(11,15,20,.98));
  border-left:1px solid rgba(34,48,69,.8);
  padding:16px;
  overflow:auto;
  transform:translateX(102%);
  transition:.25s;
  z-index:80;
}
.cart.open{ transform:translateX(0); }

.cart h2{ margin:0 0 6px; }
.cart .muted{ color: var(--muted); font-size:12px; margin-bottom:10px; }

.line{
  border:1px solid rgba(34,48,69,.75);
  background: rgba(18,26,39,.55);
  border-radius:14px;
  padding:12px;
  margin:10px 0;
}
.line-top{
  display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
}
.line b{ font-size:14px; }
.controls{
  display:flex; gap:6px; align-items:center;
}
.iconbtn{
  width:34px;height:34px;border-radius:12px;
  border:1px solid rgba(34,48,69,.85);
  background: rgba(11,15,20,.6);
  color:var(--text);
  cursor:pointer;
  font-weight:900;
}
.iconbtn.danger{
  border-color: rgba(255,93,93,.45);
  color: var(--danger);
}
.total{
  margin-top:10px;
  padding:12px;
  border-radius:14px;
  border:1px solid rgba(34,48,69,.75);
  background: rgba(18,26,39,.55);
}
.total .sum{
  display:flex; justify-content:space-between; align-items:center;
  font-weight:900;
}
.field{
  margin-top:10px;
}
.field input, .field textarea{
  width:100%;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(34,48,69,.85);
  background: rgba(11,15,20,.55);
  color: var(--text);
  outline:none;
}
.field textarea{ min-height:72px; resize:vertical; }

.footer-actions{
  display:flex;
  gap:10px;
  margin-top:12px;
}
.footer-actions .btn, .footer-actions .btn-ghost{ flex:1; }
</style>
</head>

<body>

<header>
  <div class="header-inner">
    <div class="brand">
      <div class="logo">üçó</div>
      <div>
        <h1>Alitas ‚ÄúEl Dog‚Äù <span class="badge" id="badgeCountTop">0</span></h1>
        <span class="sub">Pide y te atendemos por WhatsApp</span>
      </div>
    </div>

    <div class="top-actions">
      <div class="search">
        <span style="opacity:.8">üîé</span>
        <input id="q" placeholder="Busca: alitas, hamburguesa, papas‚Ä¶" oninput="applyFilters()" />
        <span class="hint" id="hintCount"></span>
      </div>
      <button class="btn-ghost" onclick="scrollToTop()">Inicio</button>
      <button class="btn" onclick="openCart()">Carrito <span class="badge" id="badgeCountBtn">0</span></button>
    </div>
  </div>
</header>

<div class="container">
  <div class="hero">
    <div class="left">
      <p class="title">Men√∫</p>
      <div class="meta">Elige tus productos, agrega complementos y env√≠a tu pedido.</div>
    </div>
    <div class="chips" id="chips"></div>
  </div>

  <div id="menu"></div>
</div>

<!-- FAB -->
<div class="fab" onclick="openCart()">
  <div class="dot"></div>
  <span>Ver carrito</span>
  <span class="badge" id="badgeCountFab">0</span>
</div>

<!-- Overlay + Cart -->
<div class="overlay" id="overlay" onclick="closeCart()"></div>

<div id="cart" class="cart">
  <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
    <div>
      <h2>Tu pedido</h2>
      <div class="muted">Se enviar√° por WhatsApp al restaurante.</div>
    </div>
    <button class="iconbtn" onclick="closeCart()">‚úï</button>
  </div>

  <div id="items"></div>

  <div class="total">
    <div class="sum">
      <span>Total</span>
      <span>$<span id="total">0</span></span>
    </div>
    <div class="small" id="linesInfo"></div>
  </div>

  <div class="field">
    <input id="nombre" placeholder="Tu nombre" />
  </div>
  <div class="field">
    <input id="telefono" placeholder="Tu WhatsApp (10 d√≠gitos)" inputmode="numeric" />
  </div>
  <div class="field">
    <textarea id="nota" placeholder="Notas (ej: sin cebolla, extra salsa‚Ä¶)"></textarea>
  </div>

  <div class="footer-actions">
    <button class="btn-ghost" onclick="clearCart()">Vaciar</button>
    <button class="btn" onclick="enviar()">Enviar</button>
  </div>
</div>

<script>
/* ========= CONFIG ========= */
const MENU_URL = "https://script.google.com/macros/s/AKfycbxN7uXn2y4CZMRHeMmpg525be0izu1WF2indrM8vBJq75HBxnl9kb-BtR52lCGMSMCT0g/exec";

/* ===== Estado ===== */
let state = { currency:"MXN", whatsapp:"5215567864301", items:[], options:[] };
let cart = {}; // key -> { id, qty, picks, extraTotal }

/* ===== JSONP ===== */
function loadMenu(){
  return new Promise((resolve,reject)=>{
    const cb="menuCB_"+Date.now();
    window[cb]=(data)=>{ state=data; delete window[cb]; resolve(data); };
    const s=document.createElement("script");
    s.src=`${MENU_URL}?callback=${cb}&t=${Date.now()}`;
    s.onerror=reject;
    document.body.appendChild(s);
  });
}

/* ===== Helpers ===== */
function optionsByGroup(group){ return (state.options||[]).filter(o=>o.group===group); }
function optionLabel(opt){ return opt.extra>0 ? `${opt.name} (+$${opt.extra})` : opt.name; }

function normalizeText(s){ return (s||"").toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""); }

function cartCount(){
  return Object.values(cart).reduce((a,x)=>a+(x.qty||0),0);
}
function updateBadges(){
  const c = cartCount();
  ["badgeCountTop","badgeCountBtn","badgeCountFab"].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.textContent = c;
  });
}
function formatPicks(picks){
  const parts=[];
  Object.keys(picks||{}).forEach(g=>parts.push(`${g}: ${picks[g].join(", ")}`));
  return parts.join(" | ");
}

/* ===== Render: chips categor√≠a ===== */
let activeCategory = "Todas";

function buildChips(){
  const chips = document.getElementById("chips");
  const cats = Array.from(new Set((state.items||[]).map(i=>i.category))).sort();
  const all = ["Todas", ...cats];
  chips.innerHTML = all.map(c=>`<div class="chip ${c===activeCategory?'active':''}" onclick="setCategory('${escapeQuotes(c)}')">${c}</div>`).join("");
  applyFilters();
}
function escapeQuotes(s){ return (s||"").replace(/'/g,"\\'"); }
function setCategory(cat){
  activeCategory = cat;
  buildChips();
}

/* ===== Render men√∫ ===== */
function renderMenu(){
  buildChips();
}

function applyFilters(){
  const q = normalizeText(document.getElementById("q").value);
  const menu = document.getElementById("menu");
  menu.innerHTML = "";

  // filtrar items por texto + categor√≠a
  let items = (state.items||[]).slice();

  if(activeCategory !== "Todas"){
    items = items.filter(i=>i.category===activeCategory);
  }
  if(q){
    items = items.filter(i=>{
      const t = normalizeText(`${i.name} ${i.desc} ${i.category}`);
      return t.includes(q);
    });
  }

  document.getElementById("hintCount").textContent = items.length ? `${items.length} productos` : "sin resultados";

  // agrupar por categor√≠a (si est√° en ‚ÄúTodas‚Äù)
  const byCat = {};
  items.forEach(it=>{
    const cat = activeCategory==="Todas" ? it.category : activeCategory;
    byCat[cat] = byCat[cat] || [];
    byCat[cat].push(it);
  });

  Object.keys(byCat).forEach(cat=>{
    const sec=document.createElement("div");
    sec.className="section";
    sec.innerHTML = `<h2>${cat}</h2><div class="grid"></div>`;
    const grid=sec.querySelector(".grid");

    byCat[cat].forEach(i=>{
      const card=document.createElement("div");
      card.className="card";

      const hasImg = i.imageUrl && i.imageUrl.trim().length>0;

      card.innerHTML = `
        <div class="thumb">
          ${hasImg ? `<img src="${i.imageUrl}" alt="${i.name}">` : `<div class="noimg">Sin imagen</div>`}
        </div>
        <div class="card-body">
          <div>
            <h3>${i.name}</h3>
            <div class="desc">${i.desc || ""}</div>
          </div>
          <div class="row">
            <div class="price">$${Number(i.price||0)}</div>
            <div class="small">${state.currency || "MXN"}</div>
          </div>
          <div id="opts_${i.id}"></div>
          <button class="add" onclick="addToCart('${escapeQuotes(i.id)}')">Agregar</button>
        </div>
      `;

      const optsDiv = card.querySelector(`#opts_${CSS.escape("opts_"+i.id)}`) || card.querySelector(`#opts_${i.id}`);
      // Pinta opciones si aplica
      const groups = i.optionGroups || [];
      if(groups.length){
        groups.forEach(group=>{
          const groupOpts = optionsByGroup(group);
          if(!groupOpts.length) return;

          const type = groupOpts[0].type || "single";

          const lbl=document.createElement("div");
          lbl.className="small";
          lbl.style.marginTop="6px";
          lbl.textContent = (type==="multi") ? `${group} (elige varios)` : `${group}`;
          optsDiv.appendChild(lbl);

          if(type==="single"){
            const sel=document.createElement("select");
            sel.className="select";
            sel.id = `sel_${i.id}_${group}`;
            sel.innerHTML = `<option value="">Selecciona‚Ä¶</option>` +
              groupOpts.map(o=>`<option value="${o.name}">${optionLabel(o)}</option>`).join("");
            optsDiv.appendChild(sel);
          }else{
            groupOpts.forEach(o=>{
              const row=document.createElement("label");
              row.className="small";
              row.style.display="block";
              row.style.marginTop="6px";
              row.innerHTML = `<input type="checkbox" id="chk_${i.id}_${group}_${o.name}"> ${optionLabel(o)}`;
              optsDiv.appendChild(row);
            });
          }
        });
      }

      grid.appendChild(card);
    });

    menu.appendChild(sec);
  });
}

/* ===== Picks / carrito ===== */
function collectPicks(item){
  const picks={};
  let extraTotal=0;

  (item.optionGroups||[]).forEach(group=>{
    const groupOpts = optionsByGroup(group);
    if(!groupOpts.length) return;

    const type = groupOpts[0].type || "single";

    if(type==="single"){
      const sel=document.getElementById(`sel_${item.id}_${group}`);
      if(sel && sel.value){
        picks[group]=[sel.value];
        const opt = groupOpts.find(o=>o.name===sel.value);
        if(opt) extraTotal += Number(opt.extra||0);
      }
    }else{
      const checked=[];
      groupOpts.forEach(o=>{
        const chk=document.getElementById(`chk_${item.id}_${group}_${o.name}`);
        if(chk && chk.checked){
          checked.push(o.name);
          extraTotal += Number(o.extra||0);
        }
      });
      if(checked.length) picks[group]=checked;
    }
  });

  return {picks, extraTotal};
}

function addToCart(id){
  const item = (state.items||[]).find(x=>x.id===id);
  if(!item) return;

  const {picks, extraTotal} = collectPicks(item);
  const key = id + "::" + JSON.stringify(picks || {});

  if(!cart[key]) cart[key]={id, qty:0, picks, extraTotal};
  cart[key].qty += 1;

  renderCart();
  openCart();
}

function inc(key){ if(cart[key]){ cart[key].qty++; renderCart(); } }
function dec(key){
  if(!cart[key]) return;
  cart[key].qty--;
  if(cart[key].qty<=0) delete cart[key];
  renderCart();
}
function delLine(key){ if(cart[key]){ delete cart[key]; renderCart(); } }
function clearCart(){ cart={}; renderCart(); }

function renderCart(){
  const cont=document.getElementById("items");
  const totalEl=document.getElementById("total");
  const info=document.getElementById("linesInfo");

  cont.innerHTML="";
  let total=0;
  let lines=0;

  Object.keys(cart).forEach(key=>{
    const line=cart[key];
    const item=(state.items||[]).find(i=>i.id===line.id);
    if(!item) return;

    const unit = Number(item.price||0) + Number(line.extraTotal||0);
    const sub = unit * line.qty;
    total += sub;
    lines++;

    const picksText = formatPicks(line.picks);

    const div=document.createElement("div");
    div.className="line";
    div.innerHTML = `
      <div class="line-top">
        <div>
          <b>${line.qty}x ${item.name}</b>
          ${picksText ? `<div class="small">${picksText}</div>` : ``}
          <div class="small">Unit: $${unit} ‚Äî Sub: $${sub}</div>
        </div>
        <div class="controls">
          <button class="iconbtn" onclick="dec('${escapeQuotes(key)}')">‚àí</button>
          <button class="iconbtn" onclick="inc('${escapeQuotes(key)}')">+</button>
          <button class="iconbtn danger" onclick="delLine('${escapeQuotes(key)}')">üóë</button>
        </div>
      </div>
    `;
    cont.appendChild(div);
  });

  totalEl.textContent = total;
  info.textContent = lines ? `${lines} l√≠neas en carrito` : `Carrito vac√≠o`;
  updateBadges();
}

/* ===== Drawer ===== */
function openCart(){
  document.getElementById("cart").classList.add("open");
  document.getElementById("overlay").classList.add("open");
}
function closeCart(){
  document.getElementById("cart").classList.remove("open");
  document.getElementById("overlay").classList.remove("open");
}
function scrollToTop(){ window.scrollTo({top:0, behavior:"smooth"}); }

/* ===== WhatsApp ===== */
function enviar(){
  const nombre=document.getElementById("nombre").value.trim();
  const tel=document.getElementById("telefono").value.trim();
  const nota=document.getElementById("nota").value.trim();

  if(!nombre || !tel){
    alert("Escribe tu nombre y WhatsApp");
    return;
  }
  if(Object.keys(cart).length===0){
    alert("Agrega productos al carrito");
    return;
  }

  let msg = `üçó *Alitas "El Dog"*%0A`;
  msg += `üßæ *Nuevo pedido*%0A%0A`;
  msg += `Cliente: ${encodeURIComponent(nombre)}%0A`;
  msg += `WhatsApp: ${encodeURIComponent(tel)}%0A%0A`;

  Object.keys(cart).forEach(key=>{
    const line=cart[key];
    const item=(state.items||[]).find(i=>i.id===line.id);
    if(!item) return;

    const unit = Number(item.price||0) + Number(line.extraTotal||0);
    msg += `‚Ä¢ ${line.qty}x ${encodeURIComponent(item.name)} ($${unit})%0A`;
    const picksText = formatPicks(line.picks);
    if(picksText) msg += `   - ${encodeURIComponent(picksText)}%0A`;
  });

  // total
  const total = Object.keys(cart).reduce((sum,key)=>{
    const line=cart[key];
    const item=(state.items||[]).find(i=>i.id===line.id);
    if(!item) return sum;
    const unit = Number(item.price||0) + Number(line.extraTotal||0);
    return sum + (unit * line.qty);
  },0);

  msg += `%0ATotal: $${total}%0A`;

  if(nota) msg += `%0ANota: ${encodeURIComponent(nota)}%0A`;

  window.open(`https://wa.me/${state.whatsapp || "5215567864301"}?text=${msg}`,"_blank");
}

/* ===== Init ===== */
loadMenu()
  .then((data)=>{
    if(data && data.error){
      console.error("Apps Script error payload:", data);
      alert("Error en Apps Script: revisa consola (F12)");
      return;
    }
    renderMenu();
    applyFilters();
    renderCart();
  })
  .catch((err)=>{
    console.error("Menu load error:", err);
    alert("Error cargando men√∫. Revisa consola (F12) y Network.");
  });
</script>

</body>
</html>
