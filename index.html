<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Alitas ‚ÄúEl Dog‚Äù</title>

<style>
:root{
  --bg:#0b0f14;
  --panel:#0f1622;
  --card:#111b2a;
  --border:#223147;
  --text:#eaf2ff;
  --muted:#a7b4c6;
  --accent:#f6c177;
  --r:14px;
  --shadow:0 14px 28px rgba(0,0,0,.28);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
  overflow-x:hidden; /* evita scroll lateral en m√≥vil */
}
body.noscroll{overflow:hidden}

/* ===== PRELOADER ===== */
.preloader{
  position:fixed; inset:0;
  background:rgba(11,15,20,.96);
  backdrop-filter: blur(10px);
  z-index:9999;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:18px;
}
.preloader.hidden{display:none}
.preloader-card{
  width:min(520px, 92vw);
  border:1px solid rgba(34,49,71,.85);
  background:rgba(15,22,34,.55);
  border-radius:18px;
  box-shadow:var(--shadow);
  padding:18px 16px;
  display:flex;
  gap:14px;
  align-items:center;
}
.pre-logo{
  width:54px; height:54px;
  border-radius:16px;
  border:1px solid rgba(34,49,71,.75);
  background:rgba(11,15,20,.5);
  overflow:hidden;
  display:grid; place-items:center;
  flex:0 0 auto;
}
.pre-logo img{width:100%;height:100%;object-fit:cover;display:block}
.pre-meta{flex:1; min-width:0}
.pre-title{margin:0; font-weight:900; font-size:14px}
.pre-sub{margin-top:4px; color:var(--muted); font-size:12px; line-height:1.35}
.pre-phrase{
  margin-top:10px;
  font-weight:900;
  color:var(--accent);
  font-size:13px;
  min-height:18px;
}
.pre-spin{
  width:34px;height:34px;
  border-radius:999px;
  border:3px solid rgba(246,193,119,.18);
  border-top-color: rgba(246,193,119,.95);
  animation:spin .9s linear infinite;
  flex:0 0 auto;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* ===== HEADER ===== */
header{
  position:sticky; top:0; z-index:10;
  background:rgba(11,15,20,.92);
  backdrop-filter: blur(10px);
  border-bottom:1px solid rgba(34,49,71,.75);
}
.header-inner{
  max-width:1100px; margin:auto; padding:14px 18px;
  display:flex; align-items:center; gap:12px;
}
.brand{
  display:flex; align-items:center; gap:12px;
  min-width:280px;
}
.brand-logo{
  width:44px; height:44px;
  border-radius:12px;
  border:1px solid rgba(34,49,71,.75);
  background:rgba(15,22,34,.55);
  display:grid; place-items:center;
  overflow:hidden;
  flex:0 0 auto;
}
.brand-logo img{width:100%;height:100%;object-fit:cover;display:block;}
.brand h1{margin:0; font-size:16px; font-weight:900; line-height:1.1;}
.brand .sub{display:block; font-size:12px; color:var(--muted); margin-top:2px;}

.search{
  flex:1;
  display:flex; align-items:center; gap:10px;
  padding:10px 12px; border-radius:999px;
  background:rgba(15,22,34,.65);
  border:1px solid rgba(34,49,71,.75);
  min-width:0;
}
.search input{
  width:100%; border:none; outline:none; background:transparent;
  color:var(--text); font-size:14px;
}
.hint{color:var(--muted); font-size:12px; white-space:nowrap;}

.btn{
  border:none; cursor:pointer;
  font-weight:900; border-radius:999px;
  padding:10px 14px;
  white-space:nowrap;
}
.btn-ghost{
  background:transparent;
  border:1px solid rgba(34,49,71,.75);
  color:var(--text);
}
.btn-primary{
  background:var(--accent);
  color:#1b140b;
}
.badge{
  display:inline-grid; place-items:center;
  min-width:22px; height:22px; padding:0 8px;
  border-radius:999px;
  background:rgba(246,193,119,.12);
  border:1px solid rgba(246,193,119,.25);
  color:var(--accent); font-size:12px; font-weight:900;
  margin-left:8px;
}

/* ===== BODY ===== */
.container{max-width:1100px; margin:auto; padding:18px;}
.chips{display:flex; gap:8px; flex-wrap:wrap; margin-top:14px;}
.chip{
  padding:8px 10px; border-radius:999px;
  background:rgba(15,22,34,.55);
  border:1px solid rgba(34,49,71,.70);
  color:var(--text);
  cursor:pointer;
  font-size:12px; font-weight:800;
}
.chip.active{
  border-color:rgba(246,193,119,.35);
  background:rgba(246,193,119,.10);
  color:var(--accent);
}

.section{margin-top:22px;}
.section h2{margin:0 0 12px; font-size:14px; color:var(--accent); letter-spacing:.2px;}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
  gap:14px;
}
.card{
  background:rgba(17,27,42,.78);
  border:1px solid rgba(34,49,71,.75);
  border-radius:var(--r);
  box-shadow:var(--shadow);
  overflow:hidden;
  display:flex; flex-direction:column;
  min-height:320px;
}
.thumb{
  height:160px;
  background:rgba(11,15,20,.55);
  border-bottom:1px solid rgba(34,49,71,.6);
  display:grid; place-items:center;
  overflow:hidden; /* clave: evita desborde */
}
.thumb img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
  max-width:100%;
}
.noimg{font-size:12px; color:rgba(167,180,198,.75);}

.card-body{padding:14px; display:flex; flex-direction:column; gap:10px; flex:1; min-width:0;}
.card h3{margin:0; font-size:15px;}
.desc{color:var(--muted); font-size:13px; line-height:1.35; min-height:34px; word-wrap:break-word;}
.row{display:flex; align-items:center; justify-content:space-between; gap:10px;}
.price{font-weight:900; color:var(--accent);}

.small{color:var(--muted); font-size:12px;}

.select{
  width:100%; padding:10px;
  border-radius:12px;
  border:1px solid rgba(34,49,71,.80);
  background:rgba(11,15,20,.45);
  color:var(--text);
  outline:none;
}

.add{
  margin-top:auto;
  width:100%;
  padding:11px 12px;
  border-radius:12px;
  border:none;
  cursor:pointer;
  font-weight:900;
  background:rgba(246,193,119,.92);
  color:#1b140b;
}

/* ===== FOOTER / SOCIAL ===== */
.footer{
  max-width:1100px;
  margin:26px auto 70px;
  padding:14px 18px;
  border-top:1px solid rgba(34,49,71,.6);
  color:var(--muted);
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
  justify-content:space-between;
}
.socials{display:flex; gap:8px; flex-wrap:wrap;}
.sbtn{
  display:inline-flex; align-items:center; gap:8px;
  padding:10px 12px;
  border-radius:999px;
  border:1px solid rgba(34,49,71,.75);
  background:rgba(15,22,34,.55);
  color:var(--text);
  text-decoration:none;
  font-weight:900;
  font-size:13px;
}
.sbtn:hover{border-color:rgba(246,193,119,.35)}
.sicon{opacity:.9}

/* ===== CART ===== */
.overlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.45);
  opacity:0; pointer-events:none;
  transition:.2s;
  z-index:70;
}
.overlay.open{opacity:1; pointer-events:auto;}
.cart{
  position:fixed; right:0; top:0; height:100%;
  width:min(420px, 92vw);
  background:rgba(11,15,20,.98);
  border-left:1px solid rgba(34,49,71,.80);
  padding:16px;
  overflow:auto;
  transform:translateX(102%);
  transition:.25s;
  z-index:80;
}
.cart.open{transform:translateX(0);}
.cart h2{margin:0 0 6px;}

.line{
  border:1px solid rgba(34,49,71,.75);
  background:rgba(15,22,34,.55);
  border-radius:14px;
  padding:12px;
  margin:10px 0;
}
.line-top{display:flex; justify-content:space-between; align-items:flex-start; gap:10px;}
.controls{display:flex; gap:6px; align-items:center; flex:0 0 auto;}
.iconbtn{
  width:34px;height:34px;
  border-radius:12px;
  border:1px solid rgba(34,49,71,.85);
  background:rgba(11,15,20,.60);
  color:var(--text);
  cursor:pointer;
  font-weight:900;
}

.total{
  margin-top:10px;
  padding:12px;
  border-radius:14px;
  border:1px solid rgba(34,49,71,.75);
  background:rgba(15,22,34,.55);
}
.total .sum{display:flex; justify-content:space-between; align-items:center; font-weight:900;}

.field{margin-top:10px;}
.field input,.field textarea{
  width:100%;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(34,49,71,.85);
  background:rgba(15,22,34,.45);
  color:var(--text);
  outline:none;
}
.field textarea{min-height:72px; resize:vertical;}
.footer-actions{display:flex; gap:10px; margin-top:12px;}
.footer-actions .btn{flex:1;}

.locbox{
  margin-top:10px;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(34,49,71,.75);
  background:rgba(15,22,34,.35);
}

/* ===== FAB ===== */
.fab{
  position:fixed; right:16px; bottom:16px; z-index:60;
  background:rgba(15,22,34,.86);
  border:1px solid rgba(34,49,71,.80);
  box-shadow:var(--shadow);
  border-radius:999px;
  padding:12px 14px;
  cursor:pointer;
  display:flex; align-items:center; gap:10px;
}
.fab .dot{width:10px;height:10px;border-radius:50%; background:var(--accent);}
.fab span{font-weight:900;}

/* ===== RESPONSIVE (corrige desbordes en m√≥vil) ===== */
@media (max-width: 760px){
  .header-inner{
    flex-wrap:wrap;
    gap:10px;
  }
  .brand{min-width:0; flex:1}
  .brand-logo{width:40px;height:40px;border-radius:12px}
  .search{order:3; flex:1 1 100%}
  .hint{display:none}
  .btn{padding:10px 12px}
}
@media (max-width: 420px){
  .container{padding:14px}
  .grid{grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));}
  .card{min-height:auto}
  .thumb{height:140px}
  .desc{min-height:0}
}
</style>
</head>

<body>

<!-- PRELOADER -->
<div class="preloader" id="preloader" aria-live="polite" aria-busy="true">
  <div class="preloader-card">
    <div class="pre-logo" title="Alitas El Dog">
      <img src="logo.png" alt="Logo Alitas El Dog" onerror="this.style.display='none'">
    </div>
    <div class="pre-meta">
      <div class="pre-title">Alitas ‚ÄúEl Dog‚Äù</div>
      <div class="pre-sub">Cargando men√∫ y preparando tu pedido‚Ä¶</div>
      <div class="pre-phrase" id="prePhrase">Preparando hamburguesas‚Ä¶</div>
    </div>
    <div class="pre-spin" aria-hidden="true"></div>
  </div>
</div>

<header>
  <div class="header-inner">
    <div class="brand">
      <div class="brand-logo" title="Alitas El Dog">
        <img src="logo.png" alt="Logo Alitas El Dog" onerror="this.style.display='none'">
      </div>
      <div>
        <h1>Alitas ‚ÄúEl Dog‚Äù <span class="badge" id="badgeTop">0</span></h1>
        <span class="sub">Pedido r√°pido por WhatsApp</span>
      </div>
    </div>

    <div class="search">
      <span style="opacity:.85">üîé</span>
      <input id="q" placeholder="Buscar en el men√∫..." oninput="applyFilters()" />
      <span class="hint" id="hintCount"></span>
    </div>

    <button class="btn btn-ghost" onclick="scrollToTop()">Inicio</button>
    <button class="btn btn-primary" onclick="openCart()">Carrito <span class="badge" id="badgeBtn">0</span></button>
  </div>
</header>

<div class="container">
  <div class="chips" id="chips"></div>
  <div id="menu"></div>
</div>

<div class="footer">
  <div class="small">
    üìç Pedido por WhatsApp ‚Ä¢ Cambia links de redes y tel√©fono abajo
  </div>

  <!-- Cambia estos links por los reales -->
  <div class="socials">
    <a class="sbtn" href="https://wa.me/5215539834256" target="_blank" rel="noopener">
      <span class="sicon">üü¢</span> WhatsApp
    </a>
    <a class="sbtn" href="https://facebook.com/" target="_blank" rel="noopener">
      <span class="sicon">üîµ</span> Facebook
    </a>
    <a class="sbtn" href="https://instagram.com/" target="_blank" rel="noopener">
      <span class="sicon">üü£</span> Instagram
    </a>
    <a class="sbtn" href="https://tiktok.com/" target="_blank" rel="noopener">
      <span class="sicon">‚ö´</span> TikTok
    </a>
  </div>
</div>

<div class="fab" onclick="openCart()">
  <div class="dot"></div>
  <span>Ver carrito</span>
  <span class="badge" id="badgeFab">0</span>
</div>

<div class="overlay" id="overlay" onclick="closeCart()"></div>

<div id="cart" class="cart">
  <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
    <div>
      <h2>Tu pedido</h2>
      <div class="small">Se enviar√° al restaurante por WhatsApp.</div>
    </div>
    <button class="iconbtn" onclick="closeCart()">‚úï</button>
  </div>

  <div id="items"></div>

  <div class="total">
    <div class="sum">
      <span>Total</span>
      <span>$<span id="total">0</span></span>
    </div>
    <div class="small" id="linesInfo">Carrito vac√≠o</div>
  </div>

  <!-- opcionales -->
  <div class="field">
    <input id="nombre" placeholder="Tu nombre (opcional)" autocomplete="name" />
  </div>
  <div class="field">
    <input id="telefono" placeholder="Tu WhatsApp (opcional)" inputmode="numeric" autocomplete="tel" />
  </div>

  <div class="field">
    <textarea id="nota" placeholder="Notas (sin cebolla, extra salsa, etc.)"></textarea>
  </div>

  <!-- UBICACI√ìN -->
  <div class="locbox">
    <label class="small" style="display:block; font-weight:900; color:var(--text);">
      <input type="checkbox" id="sendLocation" />
      Enviar mi ubicaci√≥n actual (GPS)
    </label>
    <div class="small" id="locStatus" style="margin-top:6px;"></div>
  </div>

  <div class="footer-actions">
    <button class="btn btn-ghost" onclick="clearCart()">Vaciar</button>
    <button class="btn btn-primary" onclick="enviar()">Enviar</button>
  </div>
</div>

<script>
/* ====== CONFIG (TU URL v5) ====== */
const MENU_URL = "https://script.google.com/macros/s/AKfycby8d_b2Vpd7PaGPcBrsL5kEOg-568h3DF_gwtaj9EWTOwPnaEuyV37Jj5KrSY4KjOG2ZA/exec";

/* ====== PRELOADER FRASES ====== */
const PRE_PHRASES = [
  "Agregando salsas‚Ä¶ üå∂Ô∏è",
  "Friendo alitas‚Ä¶ üçó",
  "Preparando hamburguesas‚Ä¶ üçî",
  "Armando tu pedido‚Ä¶ üßæ",
  "Calentando el comal‚Ä¶ üî•"
];
let preTimer = null;
function showPreloader(){
  const el = document.getElementById("preloader");
  if(!el) return;
  el.classList.remove("hidden");
  const phraseEl = document.getElementById("prePhrase");
  let idx = 0;
  phraseEl.textContent = PRE_PHRASES[idx % PRE_PHRASES.length];
  preTimer = setInterval(()=>{
    idx++;
    phraseEl.textContent = PRE_PHRASES[idx % PRE_PHRASES.length];
  }, 900);
}
function hidePreloader(){
  const el = document.getElementById("preloader");
  if(el) el.classList.add("hidden");
  if(preTimer){ clearInterval(preTimer); preTimer = null; }
}

let state = { currency:"MXN", whatsapp:"", items:[], options:[] };
let cart = {};
let activeCategory = "Todas";

/* ====== UTIL ====== */
function normalizeText(s){ return (s||"").toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""); }
function optionsByGroup(group){ return (state.options||[]).filter(o=>o.group===group); }
function optionLabel(opt){ return Number(opt.extra||0)>0 ? `${opt.name} (+$${Number(opt.extra||0)})` : opt.name; }
function formatPicks(picks){
  const parts=[];
  Object.keys(picks||{}).forEach(g=>parts.push(`${g}: ${picks[g].join(", ")}`));
  return parts.join(" | ");
}
function cartCount(){ return Object.values(cart).reduce((a,x)=>a+(x.qty||0),0); }
function updateBadges(){
  const c = cartCount();
  ["badgeTop","badgeBtn","badgeFab"].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.textContent = c;
  });
}

/* ====== LOCAL STORAGE (mejora sin afectar) ====== */
const LS_KEY = "eldog_cart_v1";
function saveCart(){
  try{ localStorage.setItem(LS_KEY, JSON.stringify(cart)); }catch(e){}
}
function loadCartFromStorage(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(raw) cart = JSON.parse(raw) || {};
  }catch(e){ cart = {}; }
}

/* ====== JSONP ====== */
function loadMenu(){
  return new Promise((resolve,reject)=>{
    const cb="menuCB_"+Date.now();
    window[cb]=(data)=>{
      try{
        state=data;
      } finally {
        delete window[cb];
      }
      resolve(data);
    };
    const s=document.createElement("script");
    s.src=`${MENU_URL}?callback=${cb}&t=${Date.now()}`;
    s.onerror=()=>reject(new Error("No se pudo cargar el script JSONP (revisa URL/CORS/Apps Script)."));
    document.body.appendChild(s);
  });
}

/* ====== UI: CATEGOR√çAS ====== */
function setCategory(cat){
  activeCategory = cat;
  buildChips();
  applyFilters();
}
function buildChips(){
  const chips = document.getElementById("chips");
  const cats = Array.from(new Set((state.items||[]).map(i=>i.category))).sort();
  const all = ["Todas", ...cats];
  chips.innerHTML = "";
  all.forEach(c=>{
    const div = document.createElement("div");
    div.className = "chip " + (c===activeCategory ? "active" : "");
    div.textContent = c;
    div.addEventListener("click", ()=>setCategory(c));
    chips.appendChild(div);
  });
}

/* ====== MENU RENDER ====== */
function applyFilters(){
  const q = normalizeText(document.getElementById("q").value);
  const menu = document.getElementById("menu");
  menu.innerHTML = "";

  let items = (state.items||[]).slice();
  if(activeCategory !== "Todas") items = items.filter(i=>i.category === activeCategory);
  if(q) items = items.filter(i => normalizeText(`${i.name} ${i.desc} ${i.category}`).includes(q));

  document.getElementById("hintCount").textContent = items.length ? `${items.length} productos` : "sin resultados";

  const byCat = {};
  items.forEach(it=>{
    const cat = (activeCategory==="Todas") ? it.category : activeCategory;
    byCat[cat] = byCat[cat] || [];
    byCat[cat].push(it);
  });

  Object.keys(byCat).forEach(cat=>{
    const sec=document.createElement("div");
    sec.className="section";
    sec.innerHTML = `<h2>${cat}</h2><div class="grid"></div>`;
    const grid=sec.querySelector(".grid");

    byCat[cat].forEach(i=>{
      const card=document.createElement("div");
      card.className="card";
      const hasImg = i.imageUrl && i.imageUrl.trim().length>0;

      card.innerHTML = `
        <div class="thumb">
          ${hasImg ? `<img src="${i.imageUrl}" alt="${i.name}">` : `<div class="noimg">Sin imagen</div>`}
        </div>
        <div class="card-body">
          <div>
            <h3>${i.name}</h3>
            <div class="desc">${i.desc || ""}</div>
          </div>
          <div class="row">
            <div class="price">$${Number(i.price||0)}</div>
            <div class="small">${state.currency || "MXN"}</div>
          </div>
          <div id="opts_${cssSafe(i.id)}"></div>
          <button class="add" type="button">Agregar</button>
        </div>
      `;

      const optsDiv = card.querySelector(`#opts_${cssSafe(i.id)}`);
      const groups = i.optionGroups || [];
      if(groups.length){
        groups.forEach(group=>{
          const groupOpts = optionsByGroup(group);
          if(!groupOpts.length) return;
          const type = groupOpts[0].type || "single";

          const lbl=document.createElement("div");
          lbl.className="small";
          lbl.style.marginTop="6px";
          lbl.style.fontWeight="900";
          lbl.style.color="var(--text)";
          lbl.textContent = (type==="multi") ? `${group} (elige varios)` : group;
          optsDiv.appendChild(lbl);

          if(type==="single"){
            const sel=document.createElement("select");
            sel.className="select";
            sel.dataset.itemId = i.id;
            sel.dataset.group = group;
            sel.innerHTML = `<option value="">Selecciona‚Ä¶</option>` +
              groupOpts.map(o=>`<option value="${escapeHtml(o.name)}">${escapeHtml(optionLabel(o))}</option>`).join("");
            optsDiv.appendChild(sel);
          } else {
            groupOpts.forEach(o=>{
              const row=document.createElement("label");
              row.className="small";
              row.style.display="block";
              row.style.marginTop="6px";
              row.style.color="var(--text)";
              const chk=document.createElement("input");
              chk.type="checkbox";
              chk.dataset.itemId = i.id;
              chk.dataset.group = group;
              chk.dataset.opt = o.name;

              row.appendChild(chk);
              row.appendChild(document.createTextNode(" " + optionLabel(o)));
              optsDiv.appendChild(row);
            });
          }
        });
      }

      const addBtn = card.querySelector(".add");
      addBtn.addEventListener("click", ()=>addToCart(i.id));

      grid.appendChild(card);
    });

    menu.appendChild(sec);
  });
}

/* ====== PICKS (sin ids fr√°giles) ====== */
function collectPicks(item){
  const picks={};
  let extraTotal=0;

  (item.optionGroups||[]).forEach(group=>{
    const groupOpts = optionsByGroup(group);
    if(!groupOpts.length) return;
    const type = groupOpts[0].type || "single";

    if(type==="single"){
      const sel=[...document.querySelectorAll('select.select')]
        .find(x=>x.dataset.itemId===item.id && x.dataset.group===group);
      if(sel && sel.value){
        picks[group]=[sel.value];
        const opt = groupOpts.find(o=>o.name===sel.value);
        if(opt) extraTotal += Number(opt.extra||0);
      }
    } else {
      const checked=[];
      groupOpts.forEach(o=>{
        const chk=[...document.querySelectorAll('input[type="checkbox"]')]
          .find(x=>x.dataset.itemId===item.id && x.dataset.group===group && x.dataset.opt===o.name);
        if(chk && chk.checked){
          checked.push(o.name);
          extraTotal += Number(o.extra||0);
        }
      });
      if(checked.length) picks[group]=checked;
    }
  });

  return {picks, extraTotal};
}

/* ====== CART ====== */
function stableKey(id, picks){
  // clave segura: encodea picks para que NUNCA rompa eventos (no se usa inline onclick)
  return id + "::" + btoa(unescape(encodeURIComponent(JSON.stringify(picks||{}))));
}
function addToCart(id){
  const item = (state.items||[]).find(x=>x.id===id);
  if(!item) return;

  const {picks, extraTotal} = collectPicks(item);
  const key = stableKey(id, picks);

  if(!cart[key]) cart[key]={id, qty:0, picks, extraTotal};
  cart[key].qty += 1;

  saveCart();
  renderCart();
  openCart();
}
function inc(key){
  if(cart[key]){
    cart[key].qty++;
    saveCart();
    renderCart();
  }
}
function dec(key){
  if(!cart[key]) return;
  cart[key].qty--;
  // ‚úÖ FIX: si llega a 0, se elimina (incluye cuando estaba en 1)
  if(cart[key].qty<=0) delete cart[key];
  saveCart();
  renderCart();
}
function delLine(key){
  if(cart[key]){
    delete cart[key];
    saveCart();
    renderCart();
  }
}
function clearCart(){
  cart={};
  saveCart();
  renderCart();
}

function renderCart(){
  const cont=document.getElementById("items");
  const totalEl=document.getElementById("total");
  const info=document.getElementById("linesInfo");

  cont.innerHTML="";
  let total=0;
  let lines=0;

  Object.keys(cart).forEach(key=>{
    const line=cart[key];
    const item=(state.items||[]).find(i=>i.id===line.id);
    if(!item) return;

    const unit = Number(item.price||0) + Number(line.extraTotal||0);
    const sub = unit * line.qty;
    total += sub;
    lines++;

    const picksText = formatPicks(line.picks);

    const div=document.createElement("div");
    div.className="line";

    const left=document.createElement("div");
    left.innerHTML = `
      <b>${line.qty}x ${escapeHtml(item.name)}</b>
      ${picksText ? `<div class="small">${escapeHtml(picksText)}</div>` : ``}
      <div class="small">Unit: $${unit} ‚Äî Sub: $${sub}</div>
    `;

    const controls=document.createElement("div");
    controls.className="controls";

    const bDec=document.createElement("button");
    bDec.className="iconbtn";
    bDec.type="button";
    bDec.textContent="‚àí";
    bDec.addEventListener("click", ()=>dec(key));

    const bInc=document.createElement("button");
    bInc.className="iconbtn";
    bInc.type="button";
    bInc.textContent="+";
    bInc.addEventListener("click", ()=>inc(key));

    const bDel=document.createElement("button");
    bDel.className="iconbtn";
    bDel.type="button";
    bDel.textContent="üóë";
    bDel.addEventListener("click", ()=>delLine(key));

    controls.appendChild(bDec);
    controls.appendChild(bInc);
    controls.appendChild(bDel);

    const top=document.createElement("div");
    top.className="line-top";
    top.appendChild(left);
    top.appendChild(controls);

    div.appendChild(top);
    cont.appendChild(div);
  });

  totalEl.textContent = total;
  info.textContent = lines ? `${lines} l√≠neas en carrito` : `Carrito vac√≠o`;
  updateBadges();
}

/* ===== CART OPEN/CLOSE + BODY LOCK ===== */
function openCart(){
  document.getElementById("cart").classList.add("open");
  document.getElementById("overlay").classList.add("open");
  document.body.classList.add("noscroll");
}
function closeCart(){
  document.getElementById("cart").classList.remove("open");
  document.getElementById("overlay").classList.remove("open");
  document.body.classList.remove("noscroll");
}
function scrollToTop(){ window.scrollTo({top:0, behavior:"smooth"}); }

/* ====== UBICACI√ìN + ENV√çO ====== */
async function enviar(){
  if(Object.keys(cart).length===0){ alert("Agrega productos al carrito"); return; }

  const nombre=(document.getElementById("nombre").value.trim()) || "(no proporcionado)";
  const tel=(document.getElementById("telefono").value.trim()) || "(no proporcionado)";
  const nota=document.getElementById("nota").value.trim();

  let msg = `üçó *Alitas "El Dog"*%0A`;
  msg += `üßæ *Nuevo pedido*%0A%0A`;
  msg += `Cliente: ${encodeURIComponent(nombre)}%0A`;
  msg += `WhatsApp: ${encodeURIComponent(tel)}%0A%0A`;

  Object.keys(cart).forEach(key=>{
    const line=cart[key];
    const item=(state.items||[]).find(i=>i.id===line.id);
    if(!item) return;

    const unit = Number(item.price||0) + Number(line.extraTotal||0);
    msg += `‚Ä¢ ${line.qty}x ${encodeURIComponent(item.name)} ($${unit})%0A`;
    const picksText = formatPicks(line.picks);
    if(picksText) msg += `   - ${encodeURIComponent(picksText)}%0A`;
  });

  const total = Object.keys(cart).reduce((sum,key)=>{
    const line=cart[key];
    const item=(state.items||[]).find(i=>i.id===line.id);
    if(!item) return sum;
    const unit = Number(item.price||0) + Number(line.extraTotal||0);
    return sum + (unit * line.qty);
  },0);

  msg += `%0ATotal: $${total}%0A`;

  // UBICACI√ìN opcional
  const wantLoc = document.getElementById("sendLocation")?.checked;
  const locStatus = document.getElementById("locStatus");
  if(locStatus) locStatus.textContent = "";

  if(wantLoc){
    if(!navigator.geolocation){
      if(locStatus) locStatus.textContent = "Tu navegador no soporta GPS.";
      msg += `%0Aüìç Ubicaci√≥n: (no soportada)%0A`;
    } else {
      if(locStatus) locStatus.textContent = "Pidiendo ubicaci√≥n‚Ä¶";
      try{
        const pos = await new Promise((resolve,reject)=>{
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy:true,
            timeout:10000,
            maximumAge:30000
          });
        });
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const maps = `https://maps.google.com/?q=${lat},${lng}`;
        msg += `%0Aüìç Ubicaci√≥n: ${encodeURIComponent(maps)}%0A`;
        if(locStatus) locStatus.textContent = "Ubicaci√≥n agregada ‚úÖ";
      }catch(err){
        if(locStatus) locStatus.textContent = "No se pudo obtener ubicaci√≥n (permiso/GPS).";
        msg += `%0Aüìç Ubicaci√≥n: (no autorizada)%0A`;
      }
    }
  }

  if(nota) msg += `%0ANota: ${encodeURIComponent(nota)}%0A`;

  const wa = state.whatsapp || "5210000000000";
  window.open(`https://wa.me/${wa}?text=${msg}`,"_blank");
}

/* ====== HELPERS (seguridad y ids) ====== */
function escapeHtml(str){
  return (str ?? "").toString()
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#39;");
}
function cssSafe(id){
  // para usar en querySelector #id sin romper
  return (id ?? "").toString().replace(/[^a-zA-Z0-9_-]/g, "_");
}

/* INIT */
(function init(){
  showPreloader();
  loadCartFromStorage();

  loadMenu()
    .then((data)=>{
      if(data && data.error){
        console.error("Apps Script payload error:", data);
        alert("Error en Apps Script: revisa consola (F12)");
        return;
      }
      buildChips();
      applyFilters();
      renderCart();
      updateBadges();
    })
    .catch((err)=>{
      console.error("Menu load error:", err);
      alert("Error cargando men√∫. Revisa consola (F12) y Network.");
    })
    .finally(()=>{
      // asegura que el preloader no se quede pegado
      setTimeout(hidePreloader, 250);
    });
})();
</script>

</body>
</html>
